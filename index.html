<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>白黒チャリ走</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #000;
  color: #fff;
  font-family: sans-serif;
  text-align: center;
}

#title, #ranking {
  display: none;
  padding-top: 80px;
}

canvas {
  display: block;
  margin: 0 auto;
  background: #000;
  touch-action: manipulation;
}

input, button {
  font-size: 18px;
  padding: 8px;
  margin-top: 10px;
}
</style>
</head>
<body>

<div id="title">
  <h1>白黒チャリ走</h1>
  <input id="nameInput" placeholder="名前を入力">
  <br>
  <button id="startBtn">スタート</button>
  <br>
  <button id="rankBtn">ランキング</button>
</div>

<div id="ranking">
  <h2>ランキング TOP10</h2>
  <ul id="rankList"></ul>
  <button id="backBtn">戻る</button>
</div>

<canvas id="game" width="360" height="640"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const title = document.getElementById("title");
const ranking = document.getElementById("ranking");

let player, obstacles, score, speed, running;
let playerName = "";

/* 初期表示 */
title.style.display = "block";
canvas.style.display = "none";

/* ボタン */
document.getElementById("startBtn").onclick = () => {
  const name = document.getElementById("nameInput").value.trim();
  if (!name) {
    alert("名前を入力して！");
    return;
  }
  playerName = name;
  startGame();
};

document.getElementById("rankBtn").onclick = showRanking;
document.getElementById("backBtn").onclick = () => {
  ranking.style.display = "none";
  title.style.display = "block";
};

/* ゲーム開始 */
function startGame() {
  title.style.display = "none";
  ranking.style.display = "none";
  canvas.style.display = "block";

  player = { x: 60, y: 520, vy: 0, size: 20, ground: true, jumpCount: 0 };
  obstacles = [];
  score = 0;
  speed = 2;
  running = true;

  requestAnimationFrame(loop);
}

/* メインループ */
function loop() {
  if (!running) return;
  update();
  draw();
  requestAnimationFrame(loop);
}

/* 更新 */
function update() {
  score += 0.08;
  speed = 2 + Math.floor(score / 200);

  player.vy += 0.45;
  player.y += player.vy;

  if (player.y >= 520) {
    player.y = 520;
    player.vy = 0;
    player.ground = true;
    player.jumpCount = 0; // 着地したらジャンプリセット
  }

  if (Math.random() < 0.012) {
    obstacles.push({
      x: canvas.width,
      w: 22,
      h: 16 + Math.random() * 10
    });
  }

  obstacles.forEach(o => o.x -= speed);
  obstacles = obstacles.filter(o => o.x > -50);

  for (let o of obstacles) {
    if (
      player.x < o.x + o.w &&
      player.x + player.size > o.x &&
      player.y + player.size > 560 - o.h
    ) {
      gameOver();
    }
  }
}

/* 描画 */
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "#fff";

  ctx.fillRect(0, 560, canvas.width, 4);

  ctx.fillRect(player.x, player.y, player.size, player.size);
  ctx.beginPath();
  ctx.arc(player.x + 5, player.y + 25, 5, 0, Math.PI * 2);
  ctx.arc(player.x + 15, player.y + 25, 5, 0, Math.PI * 2);
  ctx.fill();

  obstacles.forEach(o => {
    ctx.fillRect(o.x, 560 - o.h, o.w, o.h);
  });

  ctx.font = "20px sans-serif";
  ctx.fillText(Math.floor(score) + " m", 10, 30);
}

/* ジャンプ（二段ジャンプ対応） */
function jump() {
  if (player.jumpCount < 2) {
    player.vy = -10;
    player.jumpCount++;
    player.ground = false;
  }
}

canvas.addEventListener("touchstart", jump);
canvas.addEventListener("mousedown", jump);

/* ゲームオーバー */
function gameOver() {
  running = false;
  saveScore();
  setTimeout(showRanking, 500);
}

/* ランキング */
function saveScore() {
  const data = JSON.parse(localStorage.getItem("charisoRank") || "[]");
  data.push({ name: playerName, score: Math.floor(score) });
  data.sort((a,b)=>b.score-a.score);
  localStorage.setItem("charisoRank", JSON.stringify(data.slice(0,10)));
}

function showRanking() {
  canvas.style.display = "none";
  title.style.display = "none";
  ranking.style.display = "block";

  const list = document.getElementById("rankList");
  list.innerHTML = "";
  const data = JSON.parse(localStorage.getItem("charisoRank") || "[]");

  data.forEach((r,i)=>{
    const li = document.createElement("li");
    li.textContent = `${i+1}. ${r.name} - ${r.score}m`;
    list.appendChild(li);
  });
}
</script>

</body>
</html>
